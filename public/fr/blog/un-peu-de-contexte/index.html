<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="Salut, je suis Julien Crouzet, un développeur français."><title>Un Peu De Contexte - go get blog</title><meta property="og:title" content="Un peu de contexte - go get blog"><meta property="og:type" content="website"><meta property="og:description" content="Salut, je suis Julien Crouzet, un développeur français."><meta property="og:url" content="http://blog.juliencrouzet.fr/fr/blog/un-peu-de-contexte/"><meta property="og:site_name" content="go get blog"><meta property="og:image" content="http://blog.juliencrouzet.fr/fr/home/profile.png"><link rel="shortcut icon" href=/img/favicon.ico><link rel=stylesheet href=/css/main.min.fe936d0d99868bfa156615f3a51a35379b45ce4949c09fca41fe550ddf0d2293.css integrity="sha256-/pNtDZmGi/oVZhXzpRo1N5tFzklJwJ/KQf5VDd8NIpM=" crossorigin=anonymous media=screen></head><body><section id=top class=section><div class="container hero"><h1 class="bold-title is-1">Blog</h1></div><div class=section><div class=container><hr><nav class=navbar role=navigation aria-label="main navigation"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><div class=navbar-menu id=navMenu><a class=navbar-item href=/fr/>Accueil</a>
<a class=navbar-item href=/fr/#a-propos>À propos</a>
<a class=navbar-item href=http://blog.juliencrouzet.fr/fr/blog/>Retour à Blog</a>
<a class=navbar-item href=/fr/#contact>Contact</a>
<a class=navbar-item href=http://blog.juliencrouzet.fr/>English</a>
<a class=navbar-item href=http://blog.juliencrouzet.fr/index.xml><i class="fas fa-rss"></i></a></div></nav><hr></div><div class=container><h2 class="title is-1 top-pad strong-post-title"><a href=http://blog.juliencrouzet.fr/fr/blog/un-peu-de-contexte/>Un peu de contexte</a></h2><div class=post-data>11/06/2022
|
9 minutes de lecture</div><div class=blog-share>Partagez:
<a class=twitter-share-button href="https://twitter.com/intent/tweet?text=Un%20peu%20de%20contexte%20http%3a%2f%2fblog.juliencrouzet.fr%2ffr%2fblog%2fun-peu-de-contexte%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=235'),!1"><i class="fab fa-twitter"></i>
<span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fblog.juliencrouzet.fr%2ffr%2fblog%2fun-peu-de-contexte%2f" onclick="return window.open(this.href,'facebook-share','width=580,height=296'),!1"><i class="fab fa-facebook-f"></i>
<span class=hidden>Facebook</span></a></div><p>Tags:
<a href=/fr/tags/go>go</a></p></div><div class="container markdown top-pad"><p>Le package <a href=https://pkg.go.dev/context><code>context</code></a> de Go est un package très central et peut être
très puissant si il est utilisé correctement.
Par exemple, les package <a href=https://pkg.go.dev/net/http><code>net/http</code></a> ou <a href=https://pkg.go.dev/google.golang.org/grpc><code>grpc</code></a>
reposent sur lui.
D&rsquo;un autre coté, ses concepts peuvent être un peu difficiles à comprendre au début et peuvent être confusants,
poussant les développeurs à l&rsquo;ignorer ou mal l&rsquo;utiliser.</p><p>Essayons d&rsquo;explorer ces concepts.</p><h3 id=quest-ce-que-context- class=anchor-link><a href=#quest-ce-que-context->Qu&rsquo;est-ce que <code>context</code> ?</a></h3><p>Comme son nom le suggère, <code>context</code> permet de passer un contexte à un programme ou une partie de celui-ci,
comme une fontion, un handler de requête ou une goroutine ; un contexte peut être des données arbitraires
ou définies ou une deadline.</p><p>Par exemple, un contexte peut être :</p><ul><li>Un temps maximum pour exécuter un appel réseau (aka &ldquo;timeout&rdquo; ou &ldquo;dealine&rdquo;)</li><li>Des valeurs spécifiques à une requête HTTP comme une authentification</li><li>Une configuration d&rsquo;application passée à un autre package</li></ul><p>Un contexte est porté par une variable implémentant l&rsquo;interface <a href=https://pkg.go.dev/context#Context><code>context.Context</code></a>,
qui, par convention ou best practice, est passée aux fonctions comme premier argument, par exemple :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>myContextedFunc</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>foo</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>bar</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>De cette manière, un développeur sait qu&rsquo;une fonction qui prend un <code>context.Context</code> comme premier
argument prendra en compte et utilisera ce contexte et le passera en paramètre si elle appelle d&rsquo;autres
fonctions.</p><h3 id=alors-comment-les-utiliser- class=anchor-link><a href=#alors-comment-les-utiliser->Alors, comment les utiliser ?</a></h3><h4 id=les-contextes-racines class=anchor-link><a href=#les-contextes-racines>Les contextes racines</a></h4><p>Les contextes sont presque tous dérivés d&rsquo;un autre contexte, comme des poupées russes, ce qui veut
dire qu&rsquo;ils sont créés en disant &ldquo;Je prends ce contexte, j&rsquo;ajoute ou supprime ces propriétés, et
voici le nouveau contexte qui en résulte&rdquo;.</p><p>Les deux exeptions à ceci sont <code>context.Background()</code> et <code>context.TODO()</code>.</p><p>Ces deux fonctions créent un nouveau contexte vide, avec aucune valeur ou deadline, et ne prennent
aucun argument :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>ctx2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>()</span></span></code></pre></div><p>Dans les faits, si l&rsquo;on regarde <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.18.3:src/context/context.go;l=199">les sources du package <code>context</code></a>,
on peut voir qu&rsquo;elles retournent une valeur identique, <code>emptyCtx</code>, un contexte vide.</p><p>Alors quelle est la différence etre <code>context.Background()</code> et <code>context.TODO()</code> ? Principalement lexicale.</p><p><code>context.Background()</code> ne devrait être appellée qu&rsquo;une seule fois par programme, au plus haut niveau,
comme la fonction main() ou un package d&rsquo;initialisation.
Dans l&rsquo;image des poupées russes, ce serait la plus grande poupée, celle qui contient toutes les autres.
Le contexte retourné doit être envoyé à la première fonction prenant un contexte qui en créera un nouveau
dérivant de ce contexte vide :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>otherPackageA</span>.<span style=color:#a6e22e>Init</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>otherPackageB</span>.<span style=color:#a6e22e>Init</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}</span></span></code></pre></div><p>Le contexte créé dans cette fonction de plus haut niveau va désormais &ldquo;couler&rdquo; le long du programme,
chaque partie héritant du contexte précedent en y ajoutant ses spécificités.</p><p><code>context.TODO()</code> doit être utilisé lorsque l&rsquo;on se dit <em>&ldquo;Je dois utiliser un contexte, mais je ne sais
pas lequel encore.</em>. On peut voir cette fonction comme écrire le commentaire suivant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// @TODO : On envoit un nouveau contexte ici, il devrait être défini plus tard
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span>.<span style=color:#a6e22e>FuncReceivingContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#a6e22e>otherArg</span>)</span></span></code></pre></div><p><code>FuncReceivingContext</code> va recevoir un nouveau contexte, non dérivé des autres, avec aucune valeur ni deadline.</p><p>Certains linters et outils d&rsquo;analyse statique comme <a href=https://github.com/sylvia7788/contextcheck>contextcheck</a>
s&rsquo;assurent que tous les contextes utilisés dérivent d&rsquo;un seul <code>context.Background()</code> et échouent si le code
crée un autre contexte <code>Backgound()</code> quelque part. C&rsquo;est ici que <code>context.TODO()</code> peut être utilisé.</p><h4 id=les-contextes-dérivés class=anchor-link><a href=#les-contextes-d%c3%a9riv%c3%a9s>Les contextes dérivés</a></h4><p>Le package <a href=https://pkg.go.dev/context><code>context</code></a> offre 4 fonctions qui créent des contextes dérivés.</p><h5 id=contextwithcancelctx-contextcontext-contextcontext-func class=anchor-link><a href=#contextwithcancelctx-contextcontext-contextcontext-func><code>context.WithCancel(ctx context.Context) (context.Context, func())</code></a></h5><p>Un appel à <code>WithCancel</code> retourne un nouveau contexte derivé de celui passé en premier argument et une
fonction.</p><p>Un appel à la méthode <code>Done()</code> du nouveau contexte retourne un <a href=https://go.dev/tour/concurrency/2>channel</a>
qui sera fermé quand on appelle la fonction retrounée, nommée la <em>cancel function</em>.</p><p>Une fois que le channel retourné par <code>Done()</code> est fermé, la méthode <code>Err()</code> du nouveau contexte
retourne l&rsquo;erreur <code>context.Canceled</code> (dont le message est <em>&ldquo;context canceled&rdquo;</em>).</p><p>Ce pattern est utilisé pour indiquer à une fonction quand elle doit s&rsquo;arrêter, par exemple :</p><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>counter</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Attend que le channel retourné par Done() soit fermé
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Et on récupere le temps écoulé depuis qu&#39;on a lancé la fonction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Vous avez attendu %.2f seconde avant d&#39;appeller cancel()\n&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>start</span>).<span style=color:#a6e22e>Seconds</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// On crée un Cancel contexte depuis context.Background()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#75715e>// On lance counter() dans une goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>counter</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// On attend 0,3 seconde
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>300</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Et on appelle cancel() pour stopper l&#39;exécution de counter()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Un sleep en plus est rajouté pour laisser le temps a fmt.Printf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Vous avez attendu 0.30 seconde avant d&#39;appeller cancel()
</span></span></span></code></pre></div><em>(<a href=https://go.dev/play/p/gKODzi_T46d>essayer ce code !</a>)</em></p><p><code>WithCancel</code> est souvent utilisé avec <a href=https://go.dev/tour/flowcontrol/12><code>defer()</code></a>
pour exécuter des taches en arrière plan pendant l&rsquo;exécution du programme:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>runInBackground</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tick</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#75715e>// main s&#39;est arrêté, on arrête cette tâche en arrière plan
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>tick</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#75715e>// return pour arrêter l&#39;exécution de la goroutine (goroutine leak)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>tick</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Faire quelque chose chaque minute pendant l&#39;exécution du programme
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>runInBackground</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// reste du programme ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}</span></span></code></pre></div><p>Si le contexte passé en argument à <code>WithCancel</code> est déjà un cancel contexte, le channel de <code>Done()</code>
sera fermé quand la cancel function retournée sera appellée ou celle du parent, quelle que soit celle
qui est appellée en premier.</p><h5 id=contextwithdeadlinectx-contextcontext-timetime-contextcontext-func class=anchor-link><a href=#contextwithdeadlinectx-contextcontext-timetime-contextcontext-func><code>context.WithDeadline(ctx context.Context, time.Time) (context.Context, func())</code></a></h5><p><code>WithDeadline</code> crée un cancel contexte (<a href=#contextwithcancelctx-contextcontext-contextcontext-func>voir ci-dessus</a>),
mais avec l&rsquo;assurance que <code>Done()</code> sera fermé quand la deadline passée en second argument sera passée.</p><p>Si le channel de <code>Done()</code> est fermé suite à un appel à la cancel function, la méthode <code>Err()</code> m
retournera une erreur <code>context.Canceled</code>, mais si il est fermé car la deadline est dépassée, il
retournera une erreur <code>context.DeadlineExceeded</code> (dont le message est <em>&ldquo;context deadline exceeded&rdquo;</em>).</p><p>Ce pattern est utilisé pour donner à une fonction une deadline pour finir :</p><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>faitUnTrucLent</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>):
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;j&#39;ai pu faire un truc lent\n&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;je n&#39;ai pas pu faire un truc lent car %s\n&#34;</span>, <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>faitUnTrucRapide</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Microsecond</span>):
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;j&#39;ai pu faire un truc rapide\n&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;je n&#39;ai pas pu faire un truc rapide car %s\n&#34;</span>, <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>deadline</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithDeadline</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>deadline</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>faitUnTrucLent</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>faitUnTrucRapide</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// j&#39;ai pu faire un truc rapide
</span></span></span><span style=display:flex><span><span style=color:#75715e>// je n&#39;ai pas pu faire un truc lent car context deadline exceeded happened
</span></span></span></code></pre></div><em>(<a href=https://go.dev/play/p/xH_-YgtnNAg>essayer ce code !</a>)</em></p><p>Si le contexte parent (celui passé en premier argument) a déjà une deadline, le nouveau contexte sera
défini avec la deadline la plus récente des deux.</p><p>Même si la deadline est dépassée, il est toujours de la responsabilité de la fonction qui crée le
contexte avec deadline d&rsquo;appeller la cancel function, car elle permet de libérer les ressources
nécessaires au fonctionnement de ce contexte.
Donc <strong>TOUJOURS</strong> appeller cancel() quand on crée des contextes de deadline.</p><h5 id=contextwithtimeoutctx-contextcontext-timeduration-contextcontext-func class=anchor-link><a href=#contextwithtimeoutctx-contextcontext-timeduration-contextcontext-func><code>context.WithTimeout(ctx context.Context, time.Duration) (context.Context, func())</code></a></h5><p><code>WithTimeout</code> fonctionne de la même façon que <a href=#contextwithdeadlinectx-contextcontext-timetime-contextcontext-func><code>WithDeadline</code></a>,
a la seule différence qu&rsquo;elle prend non pas une date (time.Time) mais une durée (time.Duration), qui
sera ajoutée à l&rsquo;instant présent (time.Now()) pour définir la deadline.</p><p>A la place de faire</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>deadline</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>newContext</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithDeadline</span>(<span style=color:#a6e22e>previousContext</span>, <span style=color:#a6e22e>deadline</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()</span></span></code></pre></div><p>On fait juste</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>newContext</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>previousContext</span>, <span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()</span></span></code></pre></div><h5 id=contextwithvaluecontextcontext-key-value-any-contextcontext class=anchor-link><a href=#contextwithvaluecontextcontext-key-value-any-contextcontext><code>context.WithValue(context.Context, key, value any) context.Context</code></a></h5><p><code>WithValue</code> est utilisée pour créer un nouveau contexte contenant une valeur. Cela peut être très
utile si c&rsquo;est bien utilisé, en respectant quelques consignes.</p><p>De base, n&rsquo;importe quelle valeur peut être utilisée pour <code>key</code> and <code>value</code> du moment qu&rsquo;elles sont
d&rsquo;un type qui est comparabale.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>newContext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>previousContext</span>, <span style=color:#e6db74>&#34;réponse&#34;</span>, <span style=color:#ae81ff>42</span>)</span></span></code></pre></div><p>Mais comme best practice (vraiment, respectez celui-ci), c&rsquo;est important de ne jamais utiliser un type
built-in (string, number, struct ou interface connues) pour la valeur de <code>key</code>.
Pour un encore meilleur best practice, utilisez toujours un type non exporté du package qui utilise
cette valeur.</p><p>La raisons à cela est que tout le monde peut ajouter ou remplace une valeur à un contexte en
utilisant <code>WithValue</code>, cela veut dire que si vous utilisez une string pour <code>key</code> par exemple, une
collision avec n&rsquo;importe quel autre package utilisant la même valeur pour arriver et remplacer la
valeur que vous avez définie.</p><p>Une implémentation typique de cette consigne est la suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>monpackage</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>contextValueKeyType</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>contextValueKey</span> = <span style=color:#a6e22e>contextValueKeyType</span>(<span style=color:#e6db74>&#34;mon nom de clé&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>SetContextValue</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>contextValueKey</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetContextValue</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>contextValueKey</span>).(<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;la valeur n&#39;est pas dans le contexte&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>v</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Donc cette valeur pour être définie / lue par un autre package sans aucune collision possible :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>monpackage</span>.<span style=color:#a6e22e>GetContextValue</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// err = errors.New(&#34;la valeur n&#39;est pas dans le contexte&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>myownpackage</span>.<span style=color:#a6e22e>SetContextValue</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;test&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>myownpackage</span>.<span style=color:#a6e22e>GetContextValue</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// value = &#34;test&#34;
</span></span></span></code></pre></div><p>Il est important de garder en tete que les valeurs de contexte ne sont <strong>pas</strong> faites pour passer
des paramètres à une fonction mais pour conserver une/des valeur(s) dans une contexte donné, par
exemple, un résultat d&rsquo;authentification dans la gestion d&rsquo;une requête HTTP ou une configuration
dans l&rsquo;ensemble d&rsquo;un programme.</p><h3 id=des-exemples class=anchor-link><a href=#des-exemples>Des exemples</a></h3><h4 id=passer-un-contexte--récupérer-une-url-en-http-avec-un-timeout class=anchor-link><a href=#passer-un-contexte--r%c3%a9cup%c3%a9rer-une-url-en-http-avec-un-timeout>Passer un contexte : Récupérer une url en http avec un timeout</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// On crée un contexte avec une deadline dans deux secondes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// cancel() est appellée après l&#39;exécution pour libérer les ressources
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// on passe le contexte a la requête HTTP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequestWithContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;http://www.google.com&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>DeadlineExceeded</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#e6db74>&#34;le fetch a pris plus de 2 secondes&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// une autre erreur est arrivée
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	println(<span style=color:#a6e22e>resp</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h4 id=utiliser-un-contexte--une-fonction-qui-accepte-une-deadline class=anchor-link><a href=#utiliser-un-contexte--une-fonction-qui-accepte-une-deadline>Utiliser un contexte : Une fonction qui accepte une deadline</a></h4><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// slowFunction est une fonction qui prend 200ms s&#39;exécuter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>slowFunction</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>200</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>42</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// wrapWithDeadline va s&#39;assurer que slowFunction() est exécutée avant la deadline du contexte
</span></span></span><span style=display:flex><span><span style=color:#75715e>// si celui-ci en a une.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>wrapWithDeadline</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// On lance slowFunction() dans une goroutine, le resultat sera envoyé dans un channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>slowFunction</span>()
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Si le channel de résultat recoit le retour de slowFunction en premier, le résultat est retourné
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Si la deadline expire en premier, l&#39;erreur context.DeadlineExceeded est retournée
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>res</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>v</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx1</span>, <span style=color:#a6e22e>cancel1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>100</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel1</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>wrapWithDeadline</span>(<span style=color:#a6e22e>ctx1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>res</span>) <span style=color:#75715e>// 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>) <span style=color:#75715e>// context deadline exceeded
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx2</span>, <span style=color:#a6e22e>cancel2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>300</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel2</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>wrapWithDeadline</span>(<span style=color:#a6e22e>ctx2</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>res</span>) <span style=color:#75715e>// 42
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>) <span style=color:#75715e>// &lt;nil&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}</span></span></code></pre></div><em>(<a href=https://go.dev/play/p/omNlNVjsayK>essayer ce code !</a>)</em></p></div><div class="container giscus my-4"><script src=https://giscus.app/client.js data-repo=jucrouzet/blog data-repo-id="data-category=Comments" data-category-id="data-mapping=pathname" data-reactions-enabled=0 data-emit-metadata=0 data-theme=light data-lang=en crossorigin=anonymous async></script></div><div class=container><hr></div><div class="container has-text-centered top-pad"><a href=#top><i class="fa fa-arrow-up"></i></a></div><div class=container><hr></div><div class=section id=footer><div class="container has-text-centered"><span class=footer-text>Thème <a href=https://github.com/victoriadrake/hugo-theme-introduction/><strong>Introduction</strong></a> pour <a href=http://gohugo.io/>Hugo</a>. Fait avec <a href=https://victoria.dev><i class="fa fa-heart"></i> et <i class="fa fa-coffee"></i></a> par des contributeurs open-source.</span></div></div></div></section><script src=http://blog.juliencrouzet.fr/js/bundle.3004b3a1cb461ecc729cacf023493a688b702461783fb3bed58c02c60e60b778.js integrity="sha256-MASzoctGHsxynKzwI0k6aItwJGF4P7O+1YwCxg5gt3g="></script></body></html>